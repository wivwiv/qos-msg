import{_ as Se}from"./InfoTooltip-CPsvXzu1.js";import{q as oe,d as Ue,j as H,g as P,J as Be,m as g,w as n,u as e,y as J,r as f,o as i,b as r,a as F,t as d,c as A,e as _,F as x,k as me,a5 as D,z as Fe,aO as z,f as Ae,ai as De,p as Oe,h as Re,aM as Ee,V as Le,aP as $e,x as h,K as Te,T as de,M as Ge,E as Ne,aI as qe}from"./index-F6_Zcexc.js";import{a as ce,d as Ie,u as Ke,b as je,l as We,e as ze,c as He,f as Je,g as xe}from"./useSSO-CBpcHxsi.js";import{D as Qe}from"./http-BI9UuFDl.js";import{u as Xe}from"./useOperationConfirm-DKx22PW7.js";import{u as Ye}from"./useFormRules-BfOwVzOl.js";const B=Qe,pe=()=>{const{t:v,tl:k}=oe("General"),t=new Map([[B.totp,k("totpLabel")],[B.none,v("Base.none")],[B.disabled,v("Base.disabled")]]),c=[B.disabled,B.none],b=u=>!!u&&!c.includes(u),y=Object.values(B).reduce((u,o)=>(c.includes(o)||u.push({label:t.get(o)??"",value:o}),u),[]);return{noMFAValues:c,mfaOptions:y,isMFAEnabled:b,getMFAMethodLabel:u=>t.get(u)??""}},Ze={key:0,class:"buttons"},ea={class:"buttons"},aa=Ue({__name:"UserMFASettingDialog",props:{modelValue:{type:Boolean},user:{}},emits:["update:modelValue","submitted"],setup(v,{emit:k}){const t=v,c=k,{t:b,tl:y}=oe("General"),{mfaOptions:S,isMFAEnabled:u,getMFAMethodLabel:o}=pe(),q=H(()=>u(t.user.mfa??"")),O=S[0].value,w=P(!1),M=H({get:()=>t.modelValue,set:m=>{c("update:modelValue",m)}});Be(M,async m=>{m||Q()});const Q=()=>{w.value=!1,U.value=O},K=async()=>{try{await I(y("confirmResetTOTPSecret"));const{username:m}=t.user;if(!m)return;w.value=!0,await ce(m,{mechanism:B.totp}),D.success(b("Base.resetSuccess")),M.value=!1}catch{}finally{w.value=!1}},U=P(O),X=async()=>{try{w.value=!0;const{username:m}=t.user;if(!m)return;await ce(m,{mechanism:U.value}),D.success(b("Base.enableSuccess")),c("submitted"),M.value=!1}catch{}finally{w.value=!1}},{operationWarning:I}=Xe(),Y=async()=>{try{const{username:m}=t.user;if(!m)return;await I(b("General.confirmDisableMFA")),w.value=!0,await Ie(m),D.success(b("Base.disabledSuccess")),c("submitted"),M.value=!1}catch{}finally{w.value=!1}};return(m,R)=>{const Z=f("el-card"),E=f("el-button"),ee=f("el-option"),ae=f("el-select"),L=f("el-alert"),se=f("el-dialog");return i(),g(se,{title:e(y)("mfaSettings"),modelValue:e(M),"onUpdate:modelValue":R[1]||(R[1]=p=>J(M)?M.value=p:null),width:"400px",class:"mfa-setting-dialog","destroy-on-close":""},{default:n(()=>[r(Z,{class:"info-card",shadow:"never"},{default:n(()=>{var p,C;return[F("p",null,d(e(y)("username"))+": "+d(((p=t.user)==null?void 0:p.username)??""),1),F("p",null,d(e(b)("General.currentMFA"))+": "+d(e(o)(((C=t.user)==null?void 0:C.mfa)??"")),1)]}),_:1}),e(q)?(i(),A("div",Ze,[r(E,{type:"primary",plain:"",loading:e(w),onClick:K},{default:n(()=>[_(d(e(y)("resetTOTPSecret")),1)]),_:1},8,["loading"]),r(E,{type:"danger",plain:"",loading:e(w),onClick:Y},{default:n(()=>[_(d(e(y)("disableMFA")),1)]),_:1},8,["loading"])])):(i(),A(x,{key:1},[r(ae,{modelValue:e(U),"onUpdate:modelValue":R[0]||(R[0]=p=>J(U)?U.value=p:null)},{default:n(()=>[(i(!0),A(x,null,me(e(S),({value:p,label:C})=>(i(),g(ee,{key:p,value:p,label:C},null,8,["value","label"]))),128))]),_:1},8,["modelValue"]),r(L,{type:"info",closable:!1},{default:n(()=>[_(d(e(b)("General.enableMAFTip")),1)]),_:1}),F("div",ea,[r(E,{type:"primary",onClick:X},{default:n(()=>[_(d(e(y)("enableMFA")),1)]),_:1})])],64))]),_:1},8,["title","modelValue"])}}});function sa(){const{t:v}=Fe(),k=[{label:v("General.admin"),value:z.Admin,desc:v("General.adminDesc")},{label:v("General.viewer"),value:z.Readonly,desc:v("General.viewerDesc")}];return{apiKeyRoleOptions:[...k,{label:v("General.publisher"),value:z.Publisher}],userRoleOptions:k}}const la={class:"users app-wrapper"},ta={class:"section-header"},oa={key:1,class:"mfa-label"},na={key:4},ra={class:"dialog-align-footer"},te="local",ua={__name:"Users",setup(v){const k=Re(),{tl:t,t:c}=oe("General"),b=P(!1),y=P([]),S=P(!1),u=P(""),o=P({}),q=P(!1),O=P(),{userRoleOptions:w}=sa(),{getBackendLabel:M}=je(),Q=a=>a===te?t("local"):M(a),{loadConfigPromise:K,hasSSOEnabled:U,getEnabledSSO:X}=Ke(),I=({backend:a})=>a===te,Y=(a,l,V)=>{l!==o.value.newPassword?V(new Error(t("confirmNotMatch"))):V()},m=(a,l,V)=>{l===o.value.password?V(new Error(t("noSameNewPwd"))):V()},{createNoChineseRule:R,createRequiredRule:Z}=Ye(),E=t("passwordRequirement1")+t("semicolon")+t("passwordRequirement2").toLowerCase(),ee=H(()=>{const a={username:[{required:!0,message:t("enterOneUserName")},...R()],role:Z(c("Dashboard.role"),"select"),password:[{required:!0,message:t("pleaseEnterPassword"),trigger:["blur","change"]}],newPassword:[{required:!0,message:t("pleaseEnterNewPassword"),trigger:["blur","change"]},{pattern:de,message:E,trigger:["blur"]},{validator:m,trigger:["blur"]}],repeatPassword:[{required:!0,message:t("pleaseEnterAConfirmationPassword")},{validator:Y,trigger:["blur","change"]}]};return u.value!=="chPass"&&a.password.push({pattern:de,message:E,trigger:["blur"]}),a}),ae=H(()=>k.state.user),L=async()=>{S.value=!0;try{await X(),y.value=await We(),K&&await K}catch{}finally{S.value=!1}},se=()=>({username:"",description:"",role:z.Admin,password:""}),p=a=>a===ae.value.username,C=(a="create",l={})=>{var V;b.value=!0,(V=O.value)==null||V.resetFields(),a==="edit"?o.value=Object.assign({},l):a==="chPass"?o.value={username:l.username,password:"",newPassword:"",repeatPassword:""}:o.value=se(),u.value=a},j=P(!1),fe=a=>{o.value=a,j.value=!0},{isMFAEnabled:le,getMFAMethodLabel:ne}=pe(),be=()=>{b.value=!1},_e=()=>{o.value.username=o.value.username.trim()},re=a=>a===te?void 0:a,ue=async()=>{try{await O.value.validate(),q.value=!0;const{username:a}=o.value;if(u.value==="edit"){const l=re(o.value.backend);await ze(a,Ge.pick(o.value,["description","role"]),l),D.success(c("Base.updateSuccess"))}else if(u.value==="chPass"){const l={new_pwd:o.value.newPassword,old_pwd:o.value.password};await He(a,l),D.success(t("changePassSuccess")),p(a)&&k.commit("SET_AFTER_CURRENT_USER_PWD_CHANGED",!0)}else await Je(o.value),D.success(t("createUserSuccess"));L(),b.value=!1}catch{}finally{q.value=!1}},ge=async a=>{if(!p(a.username))try{await Ne.confirm(t("confirmDeleteUser"),{confirmButtonText:c("Base.confirm"),cancelButtonText:c("Base.cancel"),confirmButtonClass:"confirm-danger",type:"warning"});const l=re(a.backend);await xe(a.username,l),D.success(c("Base.deleteSuccess")),L()}catch{}};return De(async()=>{await L()}),(a,l)=>{const V=Ee,$=f("el-table-column"),we=f("el-tag"),W=qe,ve=f("el-table"),T=f("el-input"),G=f("el-form-item"),ye=Se,he=f("el-option"),Ve=f("el-select"),Pe=f("el-form"),ie=f("el-button"),ke=f("el-dialog"),Me=Le("loading");return i(),A(x,null,[F("div",la,[F("div",ta,[l[11]||(l[11]=F("div",null,null,-1)),r(V,{onClick:l[0]||(l[0]=s=>C())})]),Oe((i(),g(ve,{data:e(y)},{default:n(()=>[r($,{prop:"username",label:e(t)("username"),"min-width":160},null,8,["label"]),r($,{prop:"description",label:e(c)("Base.note"),"min-width":150},null,8,["label"]),r($,{label:e(c)("Dashboard.role"),"min-width":128},{default:n(({row:s})=>[_(d(("getLabelFromValueInOptionList"in a?a.getLabelFromValueInOptionList:e($e))(s.role,e(w))),1)]),_:1},8,["label"]),e(U)?(i(),g($,{key:0,label:e(t)("source"),"min-width":120},{default:n(({row:s})=>[_(d(Q(s.backend)),1)]),_:1},8,["label"])):h("",!0),r($,{label:e(t)("mfa"),"min-width":280},{default:n(({row:s})=>[s.mfa?(i(),g(we,{key:0,type:e(le)(s.mfa)?"success":"info",effect:"light"},{default:n(()=>[_(d(e(le)(s.mfa)?e(c)("Base.enabled"):e(ne)(s.mfa)),1)]),_:2},1032,["type"])):h("",!0),e(le)(s.mfa)?(i(),A("span",oa," ( "+d(e(ne)(s.mfa))+" ) ",1)):h("",!0)]),_:1},8,["label"]),r($,{label:a.$t("Base.operation"),"min-width":386},{default:n(({row:s})=>[r(W,{disabled:!a.$hasPermission("put"),onClick:N=>C("edit",s)},{default:n(()=>[_(d(a.$t("Base.edit")),1)]),_:2},1032,["disabled","onClick"]),I(s)?(i(),g(W,{key:0,disabled:!p(s.username)&&!a.$hasPermission("put"),onClick:N=>C("chPass",s)},{default:n(()=>[_(d(e(t)("changePassword")),1)]),_:2},1032,["disabled","onClick"])):h("",!0),I(s)?(i(),g(W,{key:1,disabled:!p(s.username)&&!a.$hasPermission("post"),onClick:N=>fe(s)},{default:n(()=>[_(d(e(t)("mfaSettings")),1)]),_:2},1032,["disabled","onClick"])):h("",!0),!p(s.username)&&s.username!=="admin"?(i(),g(W,{key:2,disabled:!a.$hasPermission("delete"),onClick:N=>ge(s)},{default:n(()=>[_(d(a.$t("Base.delete")),1)]),_:2},1032,["disabled","onClick"])):h("",!0)]),_:1},8,["label"])]),_:1},8,["data"])),[[Me,e(S),void 0,{lock:!0}]]),r(ke,{title:e(u)==="edit"?e(t)("editorUser"):e(u)==="chPass"?e(t)("changePassword"):e(t)("creatingUser"),modelValue:e(b),"onUpdate:modelValue":l[9]||(l[9]=s=>J(b)?b.value=s:null),"destroy-on-close":"",width:"650px"},{footer:n(()=>[F("div",ra,[r(ie,{onClick:be},{default:n(()=>[_(d(a.$t("Base.cancel")),1)]),_:1}),r(ie,{type:"primary",disabled:!p(e(o).username)&&!a.$hasPermission("post"),onClick:ue,loading:e(q)},{default:n(()=>[_(d(e(u)=="create"?a.$t("Base.create"):a.$t("Base.confirm")),1)]),_:1},8,["disabled","loading"])])]),default:n(()=>[r(Pe,{ref_key:"formCom",ref:O,model:e(o),rules:e(ee),"label-position":"top","require-asterisk-position":"right",onKeyup:l[8]||(l[8]=Te(s=>ue(),["enter"]))},{default:n(()=>[e(u)!=="chPass"?(i(),g(G,{key:0,prop:"username",label:e(t)("username")},{default:n(()=>[r(T,{modelValue:e(o).username,"onUpdate:modelValue":l[1]||(l[1]=s=>e(o).username=s),disabled:e(u)==="edit",onChange:_e},null,8,["modelValue","disabled"])]),_:1},8,["label"])):h("",!0),e(u)!=="chPass"?(i(),g(G,{key:1,label:e(c)("Base.note")},{default:n(()=>[r(T,{modelValue:e(o).description,"onUpdate:modelValue":l[2]||(l[2]=s=>e(o).description=s)},null,8,["modelValue"])]),_:1},8,["label"])):h("",!0),e(u)!=="edit"?(i(),g(G,{key:2,prop:"password",label:e(t)("password")},{default:n(()=>[r(T,{modelValue:e(o).password,"onUpdate:modelValue":l[3]||(l[3]=s=>e(o).password=s),type:"password","show-password":"",autocomplete:"new-password"},null,8,["modelValue"])]),_:1},8,["label"])):h("",!0),e(u)!=="chPass"?(i(),g(G,{key:3,label:e(c)("Dashboard.role"),prop:"role"},{default:n(()=>[r(Ve,{modelValue:e(o).role,"onUpdate:modelValue":l[4]||(l[4]=s=>e(o).role=s)},{default:n(()=>[(i(!0),A(x,null,me(e(w),({label:s,value:N,desc:Ce})=>(i(),g(he,{key:N,value:N,label:s},{default:n(()=>[_(d(s)+" ",1),r(ye,{content:Ce},null,8,["content"])]),_:2},1032,["value","label"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["label"])):h("",!0),e(u)==="chPass"?(i(),A("div",na,[r(T,{class:"username-placeholder",modelValue:e(o).username,"onUpdate:modelValue":l[5]||(l[5]=s=>e(o).username=s),disabled:""},null,8,["modelValue"]),r(G,{prop:"newPassword",label:e(t)("newPassword")},{default:n(()=>[r(T,{modelValue:e(o).newPassword,"onUpdate:modelValue":l[6]||(l[6]=s=>e(o).newPassword=s),type:"password","show-password":"",autocomplete:"new-password"},null,8,["modelValue"])]),_:1},8,["label"]),r(G,{prop:"repeatPassword",label:e(t)("confirmPassword")},{default:n(()=>[r(T,{modelValue:e(o).repeatPassword,"onUpdate:modelValue":l[7]||(l[7]=s=>e(o).repeatPassword=s),type:"password","show-password":"",autocomplete:"new-password"},null,8,["modelValue"])]),_:1},8,["label"])])):h("",!0)]),_:1},8,["model","rules"])]),_:1},8,["title","modelValue"])]),r(aa,{modelValue:e(j),"onUpdate:modelValue":l[10]||(l[10]=s=>J(j)?j.value=s:null),user:e(o),onSubmitted:L},null,8,["modelValue","user"])],64)}}},ba=Ae(ua,[["__scopeId","data-v-fb9fe754"]]);export{ba as default};
