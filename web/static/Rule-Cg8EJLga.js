import{_ as he}from"./commonPagination.vue_vue_type_style_index_0_lang-KnR7msZT.js";import{d as ue,q as re,j as ne,r as v,o as f,m as N,w as l,a as i,c as I,k as Q,u as e,F as M,b as t,aR as G,x as ce,n as te,t as k,aS as oe,aT as ke,g as w,K as Ce,ax as Y,ay as J,az as K,y as ae,W as Re,aA as Ve,aB as $e,aC as Se,M as Pe,z as we,C as Be,p as Le,aU as Oe,aL as Te,V as Ae,s as De,e as X,au as Ie,a5 as Ee,aw as Ue,aI as Fe,f as Ne}from"./index-Dp_94g6t.js";import{_ as Me}from"./CodeView.vue_vue_type_style_index_0_lang-COVY_D_l.js";import{u as xe,g as qe,a as We}from"./useRule-DGtnoBQH.js";import{_ as ie,a as je}from"./TableItemDropDown.vue_vue_type_script_setup_true_lang-BoNr_UDX.js";import{_ as ze}from"./DeleteRuleConfirm.vue_vue_type_style_index_0_lang-D3c00k2m.js";import{u as Ke,a as Qe,w as He}from"./useActionAndSourceStatus-D5aIU2c4.js";import{u as de}from"./useBridgeTypeValue-BhHkY53V.js";import{s as Ge}from"./success-filled-HwXygNV2.js";import{c as Ye}from"./circle-close-filled-D3EWRYs9.js";import{u as Je,a as Xe}from"./useHandleSourceItem-BuhTrh1O.js";import{u as Ze}from"./usePagination-CGGmJjfQ.js";import{u as et}from"./usePaginationWithHasNext-BJFMDxOM.js";import{a as tt}from"./usePaginationRemember-BBiMlW9V.js";import{u as at}from"./usePaging-pqtK_bP-.js";import{u as lt}from"./useDataHandler-URbL20R0.js";import"./useCopy-xLykWTHO.js";import"./copy-document-DOc9hYqD.js";import"./http-DdqGSA6b.js";import"./useHandleActionItem-CKafnUW3.js";import"./useOperationConfirm-DftZFsPf.js";const st={class:"rule-action-status"},ot={class:"detail-list"},nt={class:"tip"},ut=ue({__name:"RuleActionStatus",props:{rule:{}},setup(Z){const $=Z,{tl:x,t:E}=re("RuleEngine"),{getStatusClass:S,getTheWorstStatus:z}=Ke(),{getActionStatusLabel:g}=Qe(),{getGeneralTypeLabel:q}=de(),{judgeOutputType:H}=xe(),P=({actions:C})=>C.reduce((d,B)=>{const R=H(B);if(R!==oe.DataBridge){const V=R===oe.Console?x("consoleOutput"):R===oe.Republish?x("republish"):"";d.push({typeLabel:V,statusClass:G.Success,statusLabel:x("noStatus")})}return d},[]),s=({action_details:C})=>{if(!C)return{statusClass:G.Success,details:[]};const d=C.map(({status:L})=>L),B=z(d),R=S(B),V=g(B);return{statusClass:R,statusLabel:V,details:C.map(({name:L,status:O,type:_})=>({name:L,type:_,typeLabel:q(_),statusClass:S(O),statusLabel:g(O)}))}},m=ne(()=>s($.rule)),y=ne(()=>P($.rule)),c=(C,d)=>!C||!d?{}:{name:"action-detail",params:{id:ke({type:C,name:d})},query:{tab:"settings"}};return(C,d)=>{const B=v("el-icon"),R=v("router-link"),V=v("el-tooltip");return f(),N(V,{effect:"dark",placement:"top","popper-class":"rule-action-details",disabled:!e(m).details.length},{content:l(()=>[i("div",null,[i("ul",ot,[(f(!0),I(M,null,Q(e(m).details,({typeLabel:L,type:O,name:_,statusClass:W,statusLabel:h},u)=>(f(),I("li",{key:u,class:"detail-item"},[t(R,{class:"space-between",to:c(O,_),target:"_blank"},{default:l(()=>[i("div",null,[i("label",null,k(_),1),i("span",nt,"("+k(L)+")",1)]),i("span",{class:te(["text-status",W])},k(h),3)]),_:2},1032,["to"])]))),128)),(f(!0),I(M,null,Q(e(y),({typeLabel:L,statusClass:O,statusLabel:_},W)=>(f(),I("li",{key:W,class:"detail-item space-between"},[i("div",null,[i("label",null,k(L),1)]),i("span",{class:te(["text-status",O])},k(_),3)]))),128))])])]),default:l(()=>[i("span",st,[t(B,{class:te(["text-status",e(m).statusClass])},{default:l(()=>[e(m).statusClass===e(G).Success?(f(),N(e(Ge),{key:0})):e(m).statusClass===e(G).Warning?(f(),N(e(He),{key:1})):e(m).statusClass===e(G).Danger?(f(),N(e(Ye),{key:2})):ce("",!0)]),_:1},8,["class"])])]),_:1},8,["disabled"])}}}),it={class:"el-input el-input-group el-input-group--prepend el-input--suffix input-target-value"},rt={class:"el-input-group__prepend"},ct={class:"el-input__wrapper mock-wrapper"},dt={class:"endpoint-name"},pt={class:"tip endpoint-type"},mt=ue({__name:"RuleFilterForm",props:{initialValue:{type:Object,default:()=>({})}},emits:["search","refresh"],setup(Z,{emit:$}){const x=Z,E=()=>({like_id:void 0,like_from:void 0,match_from:void 0,enable:void 0,like_description:void 0,source:void 0,action:void 0}),{tl:S,t:z}=re("RuleEngine"),g=[{value:"like_from",label:z("Base.topic")},{value:"match_from",label:z("Clients.wildcard")}],q=[{value:"action",label:S("action")},{value:"source",label:"Source"}],H=$,P=w(!1),s=w(E()),m=w(g[0].value),y=w(q[0].value),c=w([]),{getActionList:C}=Je();(async()=>c.value=await C())();const d=w([]),{getSourceList:B}=Xe();(async()=>d.value=await B())();const{getGeneralTypeLabel:R}=de(),V=ne(()=>y.value==="source"?d.value:c.value);(()=>{s.value={...s.value,...x.initialValue},(s.value.like_from||s.value.match_from)&&(m.value=s.value.like_from?"like_from":"match_from"),(s.value.action||s.value.source)&&(y.value=s.value.source?"source":"action",P.value=!0),s.value.like_description&&(P.value=!0)})();const O=()=>{const h=Pe.omit(s.value,["like_from","match_from","source","action"]),u=Object.keys(h).reduce((U,T)=>{const b=h[T];return b!==void 0&&b!==""?{...U,[T]:b}:U},{});return s.value[m.value]&&(u[m.value]=s.value[m.value]),s.value[y.value]&&(u[y.value]=s.value[y.value]),u},_=()=>{H("search",O())},W=()=>{s.value=E(),_()};return(h,u)=>{const U=v("el-input"),T=v("el-form-item"),b=v("el-col"),A=v("el-option"),j=v("el-select"),le=Ve,se=$e,a=Se,r=v("el-row"),F=v("el-form");return f(),N(F,{"label-position":"left","label-width":"0px",class:"rule-filter-form",onKeyup:Ce(_,["enter"])},{default:l(()=>[t(r,{gutter:20,class:te(["",{"multiple-rows":e(P)}])},{default:l(()=>[t(b,Y(J(e(K))),{default:l(()=>[t(T,null,{default:l(()=>[t(U,{type:"text",modelValue:e(s).like_id,"onUpdate:modelValue":u[0]||(u[0]=n=>e(s).like_id=n),placeholder:"ID",clearable:"",onClear:_},null,8,["modelValue"])]),_:1})]),_:1},16),t(b,Y(J(e(K))),{default:l(()=>[t(T,null,{default:l(()=>[t(U,{type:"text",modelValue:e(s)[e(m)],"onUpdate:modelValue":u[2]||(u[2]=n=>e(s)[e(m)]=n),placeholder:h.$t("Base.topic"),clearable:"",onClear:_},{prepend:l(()=>[t(j,{class:"select-topic-type",modelValue:e(m),"onUpdate:modelValue":u[1]||(u[1]=n=>ae(m)?m.value=n:null)},{default:l(()=>[(f(),I(M,null,Q(g,({label:n,value:p})=>t(A,{key:p,label:n,value:p},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1},8,["modelValue","placeholder"])]),_:1})]),_:1},16),t(b,Y(J(e(K))),{default:l(()=>[t(T,null,{default:l(()=>[t(j,{class:"select-status",modelValue:e(s).enable,"onUpdate:modelValue":u[3]||(u[3]=n=>e(s).enable=n),clearable:"",onClear:_,placeholder:h.$t("Base.isEnabled")},{default:l(()=>[t(A,{label:h.$t("Base.enabled"),value:!0},null,8,["label"]),t(A,{label:h.$t("Base.disabled"),value:!1},null,8,["label"])]),_:1},8,["modelValue","placeholder"])]),_:1})]),_:1},16),e(P)?(f(),I(M,{key:0},[t(b,Y(J(e(K))),{default:l(()=>[t(T,null,{default:l(()=>[t(U,{type:"text",modelValue:e(s).like_description,"onUpdate:modelValue":u[4]||(u[4]=n=>e(s).like_description=n),clearable:"",onClear:_,placeholder:e(S)("note")},null,8,["modelValue","placeholder"])]),_:1})]),_:1},16),t(b,Y(J(e(K))),{default:l(()=>[t(T,null,{default:l(()=>[i("div",it,[i("div",rt,[t(j,{class:"select-topic-type",modelValue:e(y),"onUpdate:modelValue":u[5]||(u[5]=n=>ae(y)?y.value=n:null)},{default:l(()=>[(f(),I(M,null,Q(q,({label:n,value:p})=>t(A,{key:p,label:n,value:p},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),i("div",ct,[t(j,{type:"text",modelValue:e(s)[e(y)],"onUpdate:modelValue":u[6]||(u[6]=n=>e(s)[e(y)]=n),clearable:"",onClear:_},{default:l(()=>[(f(!0),I(M,null,Q(e(V),({name:n,type:p,id:ee})=>(f(),N(A,{class:"space-between",key:ee,value:ee,label:n},{default:l(()=>[i("span",dt,k(n),1),i("p",pt,k(e(R)(p)),1)]),_:2},1032,["value","label"]))),128))]),_:1},8,["modelValue"])])])]),_:1})]),_:1},16),t(b,{sm:12,md:12,lg:12})],64)):ce("",!0),t(b,Re(e(K),{class:"col-oper"}),{default:l(()=>[t(le,{onClick:_}),t(se,{onClick:W}),t(a,{modelValue:e(P),"onUpdate:modelValue":u[7]||(u[7]=n=>ae(P)?P.value=n:null)},null,8,["modelValue"])]),_:1},16)]),_:1},8,["class"])]),_:1})}}}),_t={class:"rule"},ft={class:"app-wrapper"},bt={class:"section-header"},vt={class:"inputs-container"},gt={class:"vertical-align-center"},yt={class:"emq-table-footer"},ht=ue({__name:"Rule",setup(Z){const{t:$}=we(),x=De(),E=w([]),S=w(!1),{resetPageNum:z}=Ze(),{pageMeta:g,pageParams:q,initPageMeta:H,setPageMeta:P}=et(),s=w({}),{updateParams:m,checkParamsInQuery:y}=tt("rule-detail");let c;(()=>{const{pageParams:a,filterParams:r}=y(),{sortBy:F,sortType:n,...p}=r||{};F&&n&&(c={key:F??(c==null?void 0:c.key)??"",type:n??(c==null?void 0:c.type)??"desc"}),g.value={...g.value,...a},Object.keys(p).length>0&&(s.value=p)})();const d=(a,r="RuleEngine")=>$(`${r}.${a}`),B=async a=>qe({...a,...s.value});let R=[];const V=async()=>{try{S.value=!0,R=await Oe(B),_(R),h()}catch{}finally{S.value=!1}},L=a=>{g.value.page=a.page,g.value.limit=a.limit,h()},O=a=>{const{prop:r,order:F}=a;c=r?{key:r,type:F==="descending"?"desc":"asc"}:void 0,L({page:1,limit:g.value.limit})},{setTotalData:_,getAPageData:W}=at(),h=async()=>{S.value=!0;try{const{data:a,meta:r}=W(q.value,[],c);E.value=a,P(r),m({...q.value,...s.value,sortBy:c==null?void 0:c.key,sortType:c==null?void 0:c.type})}catch{E.value=[],H()}finally{S.value=!1}},u=a=>{s.value=a,g.value.page=1,V()},U=async a=>{try{await We(a.id,{enable:a.enable}),Ee.success($(a.enable?"Base.enableSuccess":"Base.disabledSuccess"))}catch(r){console.error(r),a.enable=!a.enable}},T=a=>{x.push({name:"rule-create",query:{target:a.id,action:"copy"}})},{judgeIsWebhookRule:b}=lt(),A=w(!1),j=w(void 0),le=async a=>{const{id:r}=a||{};r&&(b(a)||(j.value=a,A.value=!0))},se=()=>{g.value.page=z(E.value,g.value.page),V()};return Be(async()=>{await V(),h()}),(a,r)=>{const F=Te,n=Ue,p=v("el-table-column"),ee=v("router-link"),pe=Me,me=v("el-tag"),_e=v("el-tooltip"),fe=v("el-switch"),be=Fe,ve=v("el-table"),ge=he,ye=Ae("loading");return f(),I(M,null,[i("div",_t,[t(mt,{class:"search-wrapper without-padding-top","initial-value":e(s),onSearch:u},null,8,["initial-value"]),i("div",ft,[i("div",bt,[r[2]||(r[2]=i("div",null,null,-1)),i("div",null,[t(F,{onClick:r[0]||(r[0]=o=>a.$router.push({name:"rule-create"}))}),t(n,{onClick:V})])]),Le((f(),N(ve,{data:e(E),"row-key":"id",onSortChange:O},{default:l(()=>[t(p,{label:e($)("Base.tableNo"),width:"64"},{default:l(({$index:o})=>[X(k(o+1),1)]),_:1},8,["label"]),t(p,{label:"ID",prop:"id",sortable:"custom","min-width":152,"show-overflow-tooltip":""},{default:l(({row:o})=>[t(ee,{to:{name:"rule-detail",params:{id:o.id}},class:"table-data-without-break"},{default:l(()=>[X(k(o.id),1)]),_:2},1032,["to"])]),_:1}),t(p,{"min-width":160,label:d("source")},{default:l(({row:o})=>[t(_e,{effect:"dark",placement:"top-start","popper-class":"code-popper"},{content:l(()=>[t(pe,{lang:"sql",code:o.sql,"show-copy-btn":!1},null,8,["code"])]),default:l(()=>[i("div",vt,[(f(!0),I(M,null,Q(o.from,D=>(f(),N(me,{class:"input-item",type:"info",key:D},{default:l(()=>[X(k(D),1)]),_:2},1024))),128))])]),_:2},1024)]),_:1},8,["label"]),t(p,{prop:"enable","min-width":140,label:a.$t("Base.isEnabled"),sortable:""},{default:l(({row:o})=>[t(ie,{disabled:!e(b)(o),name:o.id,operation:`${e($)("Base.enable")}${d("or")}${e($)("Base.disable")}`,targetLabel:d("rule")},{default:l(()=>[t(fe,{modelValue:o.enable,"onUpdate:modelValue":D=>o.enable=D,disabled:!a.$hasPermission("put")||e(b)(o),onChange:D=>U(o)},null,8,["modelValue","onUpdate:modelValue","disabled","onChange"])]),_:2},1032,["disabled","name","operation","targetLabel"])]),_:1},8,["label"]),t(p,{prop:"description",label:d("note"),"min-width":150},null,8,["label"]),t(p,{label:d("actionsCount"),prop:"actions.length",sortable:"","min-width":140},{default:l(({row:o})=>{var D;return[i("div",gt,[i("span",null,k((D=o.actions)==null?void 0:D.length),1),t(ut,{rule:o},null,8,["rule"])])]}),_:1},8,["label"]),t(p,{prop:"last_modified_at","min-width":168,label:e($)("Base.lastModified"),sortable:""},{default:l(({row:o})=>[X(k(("dateFormat"in a?a.dateFormat:e(Ie))(o.last_modified_at,"")),1)]),_:1},8,["label"]),t(p,{label:a.$t("Base.operation"),"min-width":168},{default:l(({row:o})=>[t(be,{onClick:D=>a.$router.push({name:"rule-detail",params:{id:o.id},query:{tab:"settings"}})},{default:l(()=>[X(k(a.$t("Base.setting")),1)]),_:2},1032,["onClick"]),t(ie,{disabled:!e(b)(o),name:o.id,operation:d("moreOperation"),targetLabel:d("rule")},{default:l(()=>[t(je,{"row-data":o,disabled:e(b)(o),onCopy:D=>T(o),onDelete:le},null,8,["row-data","disabled","onCopy"])]),_:2},1032,["disabled","name","operation","targetLabel"])]),_:1},8,["label"])]),_:1},8,["data"])),[[ye,e(S)]]),i("div",yt,[t(ge,{"meta-data":e(g),onLoadPage:h},null,8,["meta-data"])])])]),t(ze,{modelValue:e(A),"onUpdate:modelValue":r[1]||(r[1]=o=>ae(A)?A.value=o:null),rule:e(j),onSubmitted:se},null,8,["modelValue","rule"])],64)}}}),qt=Ne(ht,[["__scopeId","data-v-1882e420"]]);export{qt as default};
