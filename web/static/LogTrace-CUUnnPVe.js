import{_ as ne}from"./FormItemLabel.vue_vue_type_style_index_0_lang-C2ue8b3P.js";import{d as ee,q as re,j as K,c as S,a as v,b as l,u as _,y as Q,t as m,x as I,m as b,w as t,r as i,o as d,z as se,g as D,ci as L,M,ba as P,bb as G,C as de,aF as ie,bq as ae,a1 as ue,aP as W,a5 as Y,a3 as pe,E as me,f as ce,p as ge,aM as Te,V as fe,e as c,F as A,k as j,aI as ye}from"./index-gzDiX6cq.js";import{_ as be}from"./CheckIcon.vue_vue_type_style_index_0_lang-CwdT__iB.js";import{h as Le,a as Ve,s as ve,d as $e,i as ke}from"./diagnose-DSIpHM3s.js";import{u as _e}from"./useFormRules-BXbR-dxB.js";import"./MarkdownContent.vue_vue_type_style_index_0_lang-CvIt_HhB.js";import"./InfoTooltip-DsMY02kq.js";import"./check-AciMBS21.js";import"./close-DHQqAhpS.js";import"./http-BlFWNHJL.js";const Ce={class:"vertical-align-center payload-limit-input"},De={class:"switch-container"},Se={key:0,class:"tip"},Z=0,Ie=ee({__name:"PayloadLimitInput",props:{modelValue:{}},emits:["update:modelValue"],setup(e,{emit:o}){const B=e,C=o,{t:E}=re("LogTrace"),$=r=>{const u=parseFloat(r);return isNaN(u)?void 0:u},g=K({get(){var r;return((r=B.modelValue)==null?void 0:r.toString())??""},set(r){C("update:modelValue",$(r))}}),V=K({get(){return g.value===""||Number(g.value)!==Z},set(r){g.value=r?"":Z.toString()}});return(r,u)=>{const k=i("el-switch"),w=i("el-input");return d(),S("div",Ce,[v("div",De,[l(k,{modelValue:_(V),"onUpdate:modelValue":u[0]||(u[0]=y=>Q(V)?V.value=y:null)},null,8,["modelValue"]),_(V)?I("",!0):(d(),S("span",Se,m(_(E)("Extension.unlimited")),1))]),_(V)?(d(),b(w,{key:0,modelValue:_(g),"onUpdate:modelValue":u[1]||(u[1]=y=>Q(g)?g.value=y:null)},{append:t(()=>u[2]||(u[2]=[v("span",{class:"single-unit"}," B ",-1)])),_:1},8,["modelValue"])):I("",!0)])}}}),Be=30*60*1e3,x=()=>({name:"",type:L.ClientID,clientid:"",ip_address:"",topic:"",ruleid:"",startTime:["",""],payload_encode:P.Text,formatter:G.Text,payload_limit:1024}),Ee=ee({components:{PayloadLimitInput:Ie},setup(){const{t:e}=se(),o=D(!1),B=D([]),C=D(!1),E=[{value:L.ClientID,label:e("Base.clientid")},{value:L.Topic,label:e("Base.topic")},{value:L.IPAddress,label:e("Base.ip")},{value:L.RuleID,label:`${M.startCase(e("RuleEngine.rule"))} ID`}],$=D(x()),g=D(!1),{createLetterStartRule:V}=_e(),r={name:[{required:!0,message:e("General.pleaseEnter")},...V()],topic:[{required:!0,message:e("General.pleaseEnter")}],clientid:[{required:!0,message:e("General.pleaseEnter")}],ip_address:[{required:!0,message:e("General.pleaseEnter")}],ruleid:[{required:!0,message:e("General.pleaseEnter")}],startTime:[{validator(n,s,a){s&&s[0]&&s[1]?a():a(new Error(e("LogTrace.needStartTime")))}}]},u=D(null),k=[{label:"Text",value:P.Text},{label:"HEX",value:P.HEX},{label:"Hidden",value:P.Hidden}],w=[{label:"JSON",value:G.JSON},{label:"Text",value:G.Text}],y=n=>Object.keys(n).reduce((s,a)=>s+n[a],0),p=async()=>{o.value=!0;try{const n=await Le();B.value=n.map(s=>({...s,totalLogSize:y(s.log_size),isLoading:!1}))}catch{}finally{o.value=!1}},T=n=>W(n,E),U=n=>W(n,k),N=async()=>{var n;(n=u.value)==null||n.validate(async s=>{if(!s)return;C.value=!0;const{clientid:a,topic:f,ip_address:le,ruleid:te,startTime:J,type:oe,formatter:X}=$.value,F={...M.omit($.value,["clientid","topic","ip_address","startTime"]),start_at:new Date(J[0]).toISOString(),end_at:new Date(J[1]).toISOString(),...X?{formatter:X}:{}};switch(oe){case L.ClientID:F.clientid=a;break;case L.Topic:F.topic=f;break;case L.IPAddress:F.ip_address=le;break;case L.RuleID:F.ruleid=te;break}try{await Ve(F),Y.success(e("LogTrace.createSuc")),p(),h()}catch{}finally{C.value=!1}})},h=()=>{g.value=!1},O=()=>{$.value=x()},R=async n=>{if(n.name)try{await ve(n.name),Y.success(e("LogTrace.stopSuc")),p()}catch{}},z=async()=>{var s;g.value=!0;const n=new Date;$.value.startTime=[n,new Date(n.getTime()+Be)],await pe(),(s=u.value)==null||s.clearValidate()},q=async n=>{if(n.name)try{await me.confirm(e("LogTrace.confirmDeleteTrace"),{confirmButtonText:e("Base.confirm"),cancelButtonText:e("Base.cancel"),confirmButtonClass:"confirm-danger",type:"warning"}),await $e(n.name),Y.success(e("LogTrace.deleteSuc")),p()}catch{}},H=async n=>{if(n.name)try{n.isLoading=!0,await ke(n.name)}catch{}finally{n.isLoading=!1}};return de(()=>{p()}),{t:e,tl:n=>e("LogTrace."+n),traceTbLoading:o,traceTable:B,CheckStatus:ie,createForm:u,typeOptions:E,record:$,encodeTypeOpt:k,formatterOpt:w,LogTraceType:L,startCase:M.startCase,transMemorySizeNumToStr:ae,getTypeLabelByValue:T,getEncodeTypeLabelByValue:U,submitTrace:N,stopTraceHandler:R,openCreateDialog:z,dayjs:ue,download:H,deleteTraceHandler:q,createRules:r,createDialog:g,createLoading:C,cancelDialog:h,initForm:O}}}),we={class:"log-trace app-wrapper"},Ue={class:"section-header"},Ne={class:"vertical-align-center"},Fe={class:"dialog-align-footer"};function he(e,o,B,C,E,$){const g=Te,V=i("router-link"),r=i("el-table-column"),u=be,k=ye,w=i("el-table"),y=i("el-input"),p=i("el-form-item"),T=i("el-col"),U=i("el-option"),N=i("el-select"),h=i("el-date-picker"),O=ne,R=i("PayloadLimitInput"),z=i("el-row"),q=i("el-form"),H=i("el-button"),n=i("el-dialog"),s=fe("loading");return d(),S("div",we,[v("div",Ue,[o[13]||(o[13]=v("div",null,null,-1)),v("div",null,[l(g,{onClick:e.openCreateDialog},null,8,["onClick"])])]),ge((d(),b(w,{data:e.traceTable,class:"data-table"},{default:t(()=>[l(r,{label:e.$t("LogTrace.name"),prop:"name","min-width":100},{default:t(({row:a})=>[l(V,{to:{name:"log-trace-detail",params:{id:a.name}}},{default:t(()=>[c(m(a.name),1)]),_:2},1032,["to"])]),_:1},8,["label"]),l(r,{label:e.$t("LogTrace.type"),prop:"type","min-width":100},{default:t(({row:a})=>[c(m(e.getTypeLabelByValue(a.type)),1)]),_:1},8,["label"]),l(r,{label:e.$t("LogTrace.condition"),"min-width":100},{default:t(({row:a})=>[c(m(a[a.type]),1)]),_:1},8,["label"]),l(r,{label:e.$t("LogTrace.startEndTime"),sortable:"","sort-by":({start_at:a})=>new Date(a).getTime(),"min-width":188},{default:t(({row:a})=>[c(m(e.dayjs(a.start_at).format("YYYY-MM-DD HH:mm:ss"))+" ",1),o[14]||(o[14]=v("br",null,null,-1)),c(" "+m(e.dayjs(a.end_at).format("YYYY-MM-DD HH:mm:ss")),1)]),_:1},8,["label","sort-by"]),l(r,{label:e.$t("LogTrace.status"),prop:"status","min-width":120},{default:t(({row:a})=>[v("div",Ne,[l(u,{status:a.status==="running"?e.CheckStatus.Check:a.status==="stopped"?e.CheckStatus.Close:e.CheckStatus.Disable},null,8,["status"]),v("span",null,m(a.status&&e.$t("LogTrace.s"+a.status)),1)])]),_:1},8,["label"]),l(r,{label:e.$t("LogTrace.logSize"),prop:"totalLogSize",sortable:"","min-width":112},{default:t(({row:a})=>[c(m(("transMemorySizeNumToStr"in e?e.transMemorySizeNumToStr:_(ae))(a.totalLogSize,2)),1)]),_:1},8,["label"]),l(r,{label:e.$t("LogTrace.payload"),"min-width":100},{default:t(({row:a})=>[c(m(e.getEncodeTypeLabelByValue(a.payload_encode)),1)]),_:1},8,["label"]),l(r,{label:e.tl("payloadLimit"),"min-width":100},{default:t(({row:a})=>[c(m(a.payload_limit===0?e.t("Extension.unlimited"):a.payload_limit&&`${a.payload_limit} B`),1)]),_:1},8,["label"]),l(r,{label:e.$t("Base.operation"),"min-width":188},{default:t(({row:a})=>[l(k,{onClick:f=>e.download(a),loading:a.isLoading},{default:t(()=>[c(m(e.$t("LogTrace.download")),1)]),_:2},1032,["onClick","loading"]),a.status!=="stopped"?(d(),b(k,{key:0,type:"danger",disabled:!e.$hasPermission("put"),onClick:f=>e.stopTraceHandler(a)},{default:t(()=>[c(m(e.$t("LogTrace.stop")),1)]),_:2},1032,["disabled","onClick"])):(d(),b(k,{key:1,disabled:!e.$hasPermission("delete"),onClick:f=>e.deleteTraceHandler(a)},{default:t(()=>[c(m(e.$t("LogTrace.delete")),1)]),_:2},1032,["disabled","onClick"]))]),_:1},8,["label"])]),_:1},8,["data"])),[[s,e.traceTbLoading]]),l(n,{title:e.$t("LogTrace.createLog"),modelValue:e.createDialog,"onUpdate:modelValue":o[12]||(o[12]=a=>e.createDialog=a),onClose:e.initForm,width:"800px"},{footer:t(()=>[v("div",Fe,[l(H,{onClick:o[10]||(o[10]=a=>e.cancelDialog())},{default:t(()=>[c(m(e.$t("Base.cancel")),1)]),_:1}),l(H,{class:"dialog-primary-btn",type:"primary",onClick:o[11]||(o[11]=a=>e.submitTrace()),disabled:!e.$hasPermission("post"),loading:e.createLoading},{default:t(()=>[c(m(e.$t("Base.create")),1)]),_:1},8,["disabled","loading"])])]),default:t(()=>[l(q,{ref:"createForm","label-position":"top","require-asterisk-position":"right",model:e.record,rules:e.createRules},{default:t(()=>[l(z,{gutter:20},{default:t(()=>[l(T,{span:12},{default:t(()=>[l(p,{label:e.$t("LogTrace.name"),prop:"name"},{default:t(()=>[l(y,{modelValue:e.record.name,"onUpdate:modelValue":o[0]||(o[0]=a=>e.record.name=a)},null,8,["modelValue"])]),_:1},8,["label"])]),_:1}),l(T,{span:12},{default:t(()=>[l(p,{label:e.$t("LogTrace.type"),prop:"type"},{default:t(()=>[l(N,{modelValue:e.record.type,"onUpdate:modelValue":o[1]||(o[1]=a=>e.record.type=a)},{default:t(()=>[(d(!0),S(A,null,j(e.typeOptions,({value:a,label:f})=>(d(),b(U,{key:a,value:a,label:f},null,8,["value","label"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["label"])]),_:1}),e.record.type===e.LogTraceType.Topic?(d(),b(T,{key:0,span:12},{default:t(()=>[l(p,{label:e.$t("Base.topic"),prop:"topic"},{default:t(()=>[l(y,{modelValue:e.record.topic,"onUpdate:modelValue":o[2]||(o[2]=a=>e.record.topic=a)},null,8,["modelValue"])]),_:1},8,["label"])]),_:1})):I("",!0),e.record.type===e.LogTraceType.ClientID?(d(),b(T,{key:1,span:12},{default:t(()=>[l(p,{label:e.$t("Base.clientid"),prop:"clientid"},{default:t(()=>[l(y,{modelValue:e.record.clientid,"onUpdate:modelValue":o[3]||(o[3]=a=>e.record.clientid=a)},null,8,["modelValue"])]),_:1},8,["label"])]),_:1})):I("",!0),e.record.type===e.LogTraceType.IPAddress?(d(),b(T,{key:2,span:12},{default:t(()=>[l(p,{label:e.$t("Base.ip"),prop:"ip_address"},{default:t(()=>[l(y,{modelValue:e.record.ip_address,"onUpdate:modelValue":o[4]||(o[4]=a=>e.record.ip_address=a)},null,8,["modelValue"])]),_:1},8,["label"])]),_:1})):I("",!0),e.record.type===e.LogTraceType.RuleID?(d(),b(T,{key:3,span:12},{default:t(()=>[l(p,{label:`${("startCase"in e?e.startCase:_(M.startCase))(e.t("RuleEngine.rule"))} ID`,prop:"ruleid"},{default:t(()=>[l(y,{modelValue:e.record.ruleid,"onUpdate:modelValue":o[5]||(o[5]=a=>e.record.ruleid=a)},null,8,["modelValue"])]),_:1},8,["label"])]),_:1})):I("",!0),l(T,{span:12,style:{clear:"both"}},{default:t(()=>[l(p,{label:e.$t("LogTrace.startEndTime"),prop:"startTime"},{default:t(()=>[l(h,{type:"datetimerange","start-placeholder":e.$t("LogTrace.startTime"),"end-placeholder":e.$t("LogTrace.endTime"),modelValue:e.record.startTime,"onUpdate:modelValue":o[6]||(o[6]=a=>e.record.startTime=a)},null,8,["start-placeholder","end-placeholder","modelValue"])]),_:1},8,["label"])]),_:1}),l(T,{span:12},{default:t(()=>[l(p,{prop:"formatter",label:e.tl("formatter")},{default:t(()=>[l(N,{modelValue:e.record.formatter,"onUpdate:modelValue":o[7]||(o[7]=a=>e.record.formatter=a)},{default:t(()=>[(d(!0),S(A,null,j(e.formatterOpt,({label:a,value:f})=>(d(),b(U,{key:f,value:f,label:a},null,8,["value","label"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["label"])]),_:1}),l(T,{span:12},{default:t(()=>[l(p,{prop:"payload_encode"},{default:t(()=>[l(O,{label:e.$t("LogTrace.payload"),desc:e.$t("LogTrace.payloadDesc"),"desc-marked":""},null,8,["label","desc"]),l(N,{modelValue:e.record.payload_encode,"onUpdate:modelValue":o[8]||(o[8]=a=>e.record.payload_encode=a)},{default:t(()=>[(d(!0),S(A,null,j(e.encodeTypeOpt,({label:a,value:f})=>(d(),b(U,{key:f,value:f,label:a},null,8,["value","label"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),l(T,{span:12},{default:t(()=>[l(p,{prop:"payload_limit"},{label:t(()=>[l(O,{label:e.tl("payloadLimit"),desc:e.tl("payloadLimitDesc"),"desc-marked":""},null,8,["label","desc"])]),default:t(()=>[l(R,{modelValue:e.record.payload_limit,"onUpdate:modelValue":o[9]||(o[9]=a=>e.record.payload_limit=a)},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["title","modelValue","onClose"])])}const Je=ce(Ee,[["render",he]]);export{Je as default};
